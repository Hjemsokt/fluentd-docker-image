#!/bin/bash
# AUTOMATICALLY GENERATED
# DO NOT EDIT THIS FILE DIRECTLY, USE /post_push.erb

set -e

# Parse image name for repo name
tagStart=$(expr index "$IMAGE_NAME" :)
repoName=${IMAGE_NAME:0:tagStart-1}

# Download manifest tool
curl -Lo manifest-tool https://github.com/estesp/manifest-tool/releases/download/v1.0.3/manifest-tool-linux-amd64
chmod +x manifest-tool

# Tag and push image for each additional tag
for tag in {v1.15.0-debian-armhf-1.0,v1.15-debian-armhf-1,edge-debian-armhf}; do
  docker tag $IMAGE_NAME ${repoName}:${tag}
  docker push ${repoName}:${tag}

  archTag=${tag/amd64/ARCH}
  archTag=${archTag/arm64/ARCH}
  archTag=${archTag/armhf/ARCH}
  noArchTag=${tag/-amd64/}
  noArchTag=${noArchTag/-arm64/}
  noArchTag=${noArchTag/-armhf/}
  # Note: this will fail until three of the amd64, armv7, and arm64 images have been pushed
  ./manifest-tool push from-args \
      --platforms linux/amd64,linux/arm/v7,linux/arm64 \
      --template ${repoName}:${archTag} \
      --target ${repoName}:${noArchTag} || true

done
